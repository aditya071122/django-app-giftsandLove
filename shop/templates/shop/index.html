{% extends 'shop/basic.html' %}

{% block css %}

/* ---- GRID FIX (4 items per row + space) ---- */
.row {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 22px; /* space between cards */
}

.col-md-3 {
    flex: 0 0 calc(25% - 22px); /* EXACT 4 items per row */
    display: flex;
    justify-content: center;
}

/* ---- CARD STYLE ---- */
.card {
    width: 18rem;
    height: 33rem;
    display: flex;
    flex-direction: column;
    border-radius: 18px;
    overflow: hidden;

    border: 3px solid transparent;
    background: linear-gradient(#fff, #fff) padding-box,
                linear-gradient(135deg, #d83389, #7b2ff7) border-box;

    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

/* ---- CARD IMAGE ---- */
.card-img-top {
    height: 260px;
    object-fit: contain;
    background: #fff;
    padding: 10px;
    border-bottom: 4px solid #eec9ff;
}

/* ---- CARD BODY ---- */
.card-body {
    background: linear-gradient(145deg, #ffe4f3, #fce9ff);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding-bottom: 15px;
    padding-top: 15px;
}

/* ---- TITLE ---- */
.card-title {
    font-weight: 600;
    color: #8c1aff;
    text-align: center;
}

/* ---- DESCRIPTION ---- */
.card-text {
    white-space: normal;
    font-size: 14px;
    color: #4a245e;
}

/* ---- PRICE ---- */
.price {
    font-size: 18px;
    color: #000;
    font-weight: 600;
    text-align: center;
}

/* ---- BUTTON ROW ---- */
.btn-row {
    display: flex;
    gap: 14px;
    margin-top: 18px;
    align-items: center;
    justify-content: center;
}

/* Buttons */
.btn-row .btn {
    display: flex;
    justify-content: center;
    font-weight: 700;
    border: none;
    transition: 0.18s ease;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

/* Add to cart button */
.btn-row .btn.add-cart {
    flex: 0 0 22%;
    min-width: 72px;
    max-width: 110px;
    height: 64px;
    padding: 8px 10px;
    border-radius: 14px;
    font-size: 14px;
}

/* Quick view button */
.btn-row .btn.quick-view {
    flex: 1 1 60%;
    height: 64px;
    padding: 10px 18px;
    border-radius: 14px;
    font-size: 18px;
}

.btn-row .btn.btn-primary {
    background: linear-gradient(135deg, #af40ff, #d96bff);
    color: #fff;
}

.btn-row .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.12);
}

/* ---- QUANTITY BOX ---- */
.qty-box {
    display: flex;
    align-items: center;
    gap: 8px;
}

.qty-box button {
    width: 36px;
    height: 36px;
    font-size: 20px;
}

/* ---- CAROUSEL ARROWS OUTSIDE ---- */
.carousel-control-prev,
.carousel-control-next {
    width: 40px !important;
    height: 40px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    z-index: 20 !important;
}

.carousel-control-prev { left: -45px !important; }
.carousel-control-next { right: -45px !important; }

.carousel-control-prev-icon,
.carousel-control-next-icon {
    background-size: 100%;
    pointer-events: none;
}

.carousel-control-prev,
.carousel-control-next {
    pointer-events: auto !important;
}

/* ---- MOBILE FIX ---- */
@media (max-width: 768px) {
    .col-md-3 {
        flex: 0 0 calc(50% - 22px); /* 2 per row on mobile */
    }
}

@media (max-width: 500px) {
    .col-md-3 {
        flex: 0 0 100%; /* 1 per row small screens */
    }

    .btn-row {
        flex-direction: column;
        gap: 10px;
    }
}
{% endblock %}

{% block body %}
{% load static %}

<div class="container my-3">

  {% for product, range, nslides in allProds %}
  <h1 class="text-center mb-4">{{ product.0.category }}</h1>
  <div class="row">
    <div id="demo{{ forloop.counter }}" class="carousel slide mb-5" data-bs-ride="false">

      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="row justify-content-center">
            {% for p in product|slice:":4" %}
            <div class="col-md-3">
              <div class="card">
                <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.product_name }}">
                <div class="card-body">
                  <h5 class="card-title" id="namepr{{p.id}}">{{ p.product_name }}</h5>
                  <p class="card-text">
                    {{ p.desc|truncatechars:60 }}<br>
                    {{ p.price }} Rs.<br>
                    {{ p.pub_date }}
                  </p>

                  <div class="btn-row">
                    <span id="divpr{{p.id}}" class="divpr">
                      <button id="pr{{p.id}}" class="btn btn-primary add-cart cart" type="button">
                        Add to cart
                      </button>
                    </span>

                    <a href="/shop/products/{{p.id}}" class="btn btn-primary quick-view">
                      Quick view
                    </a>
                  </div>

                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        {% if product|length > 4 %}
        <div class="carousel-item">
          <div class="row justify-content-center">
            {% for p in product|slice:"4:" %}
            <div class="col-md-3">
              <div class="card">
                <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.product_name }}">
                <div class="card-body">
                  <h5 class="card-title" id="namepr{{p.id}}">{{ p.product_name }}</h5>
                  <p class="card-text">
                    {{ p.desc }}<br>
                    {{ p.price }} Rs.<br>
                    {{ p.pub_date }}
                  </p>

                  <div class="btn-row">
                    <span id="divpr{{p.id}}" class="divpr">
                      <button id="pr{{p.id}}" class="btn btn-primary add-cart cart">
                        Add to cart
                      </button>
                    </span>

                    <a href="/shop/products/{{p.id}}" class="btn btn-primary quick-view">
                      Quick view
                    </a>
                  </div>

                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>

      {% if product|length > 4 %}
      <button class="carousel-control-prev" type="button" data-bs-target="#demo{{ forloop.counter }}" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>

      <button class="carousel-control-next" type="button" data-bs-target="#demo{{ forloop.counter }}" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
      {% endif %}

    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}

{% block js %}
<script>

if (localStorage.getItem('cart') == null) {
  var cart = {};
} else {
  cart = JSON.parse(localStorage.getItem('cart'));
  updateCart(cart);
}

//$('.cart').click(function () {
$('.divpr').on('click','button.cart',function(){
  var idstr = this.id.toString();
  if (cart[idstr] != undefined) {
    qty=cart[idstr][0]+1;
    
  } else {
    qty=1;
    name=document.getElementById('name'+idstr).innerHTML;
    cart[idstr] = [qty , name];
  }
  updateCart(cart);
});
updatePopover(cart);

// Initialize popover
document.addEventListener("DOMContentLoaded", function () {
    const popTrigger = document.getElementById("popcart");

    const popover = new bootstrap.Popover(popTrigger, {
        html: true,
        sanitize: false,
        trigger: "manual",
        placement: "bottom"
    });

    popTrigger.addEventListener("click", function () {
        popover.toggle();
    });

    updatePopover(cart); 
});

// UPDATE POPOVER WITH BUTTONS
function updatePopover(cart) {
    let popStr = `
      <div class="popover-body">
        <h5 style='color:#7b2ff7; margin-bottom:10px;'>ðŸ›’ Your Cart</h5>
        <div style='max-height:180px; overflow-y:auto;'>
    `;

    let i = 1;
    for (let item in cart) {
        let name = document.getElementById("name" + item).innerText;

        popStr += `
            <div style="padding:6px 0; border-bottom:1px solid #ddd;">
                <b>${i}.</b> ${name}<br>
                <span style="color:#444;">Qty: <b>${cart[item][0]}</b></span>
            </div>
        `;
        i++;
    }

    if (i === 1) {
        popStr += `<p style='color:#999;'>Your cart is empty</p>`;
    }

    popStr += `
        </div>

        <div style='margin-top:10px; font-weight:bold; color:#8c1aff;'>
            Total Items: ${Object.values(cart).reduce((a, b) => a + b, 0)}
        </div>

        <div style='margin-top:15px; display:flex; gap:10px;'>
            <button onclick="clearCart()" class="btn btn-danger btn-sm" style="flex:1;">
                Clear Cart
            </button>

            <a href="/shop/checkout" class="btn btn-success btn-sm" style="flex:1; text-align:center;">
                Checkout
            </a>
        </div>

      </div>
    `;

    const popTrigger = document.getElementById("popcart");

    popTrigger.setAttribute("data-bs-content", popStr);

    const pop = bootstrap.Popover.getInstance(popTrigger);
    if (pop) {
        pop.setContent({ '.popover-body': popStr });
    }
}

// CLEAR CART
function clearCart(){
  cart = JSON.parse(localStorage.getItem('cart'));
  for(var item in cart){
    document.getElementById('div'+item).innerHTML =
      '<button id="'+item+'" class="btn btn-primary add-cart cart" type="button">Add to cart</button>';
  }
  localStorage.clear();
  cart = {};
  updateCart(cart);
}

// UPDATE CART
function updateCart(cart){
  var sum = 0;
  for(var item in cart){
    sum += cart[item][0];
    document.getElementById('div' + item).innerHTML =
      "<div class='qty-box'>" +
        "<button id='minus" + item + "' class='btn btn-primary minus'>-</button>" +
        "<span id='val" + item + "'>" + cart[item][0] + "</span>" +
        "<button id='plus" + item + "' class='btn btn-primary plus'>+</button>" +
      "</div>";
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  document.getElementById('cart').innerHTML = sum;

  updatePopover(cart); 
}

$('.divpr').on("click","button.minus",function(){
  a = this.id.slice(7);
  cart['pr'+a][0] = Math.max(0, cart['pr'+a][0] - 1);
  document.getElementById('valpr'+a).innerHTML = cart['pr'+a][0];
  updateCart(cart);
});

$('.divpr').on("click","button.plus",function(){
  a = this.id.slice(6);
  cart['pr'+a][0] = cart['pr'+a][0] + 1;
  document.getElementById('valpr'+a).innerHTML = cart['pr'+a][0];
  updateCart(cart);
});

</script>
{% endblock %}
